@model ConsommiTounsi.Models.Event


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">

<div class="modal fade show" id="exampleModalScrollable" tabindex="-1" role="dialog" aria-labelledby="exampleModalScrollableTitle" style="padding-right: 16px; display: block;" aria-modal="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title mt-0" id="exampleModalScrollableTitle">Add event</h5>
                <button type="button" class="btn-close" data-sm-dismiss="modal" aria-label="Close">
                </button>
            </div>
            <div class="modal-body p-4">
                <form id="addForm" class="needs-validation was-validated" novalidate="" method="post" enctype="multipart/form-data">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label" for="validationCustom01">Title</label>
                                <input type="text" class="form-control" id="titleEvent" placeholder="Enter Title" value="" required="">
                                <div class="valid-feedback">
                                    Looks good!
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label" for="validationCustom01">Adress</label>
                                <input type="text" class="form-control" id="addressEvent" placeholder="Enter Adress" value="" required="">
                                <div class="valid-feedback">
                                    Looks good!
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="mb-3">
                                <label class="form-label">Places Number</label>
                                <select class="form-control form-select" id="totalPlacesEvent" required="">
                                    <option value="bg-danger" selected="">10</option>
                                    <option value="bg-success">20</option>
                                    <option value="bg-primary">30</option>
                                    <option value="bg-info">40</option>
                                    <option value="bg-dark">50</option>
                                </select>
                                <div class="invalid-feedback">Please select a valid event category</div>
                            </div>
                        </div>

                    </div>
                    <div class="mb-3">
                        <input type="file" id="imageEvent" name="image" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <div>
                            <textarea value="" required="" id="descriptionEvent" class="form-control parsley-error" rows="5" data-parsley-id="21" aria-describedby="parsley-id-21"></textarea>
                            <div class="valid-feedback">
                                Looks good!
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Start Date</label>
                        <input class="form-control" type="date" value="" id="startDate">




                    </div>
                    <div class="mb-3">

                        <label class="form-label">End Date</label>
                        <input class="form-control" type="date" value="" id="endDate">
                    </div>



                        <div class="row">
                            <div class="col-md-4">
                                <br />

                                <div class="mb-3">

                                    <label class="form-label" for="validationCustom03">DiscountPercentage</label>
                                    <input type="number" class="form-control" id="discountPercentageEvent" placeholder="discount" required="">
                                    <div class="invalid-feedback">
                                        Please provide a valid city.
                                    </div>

                                </div>


                            </div>
                            <div class="col-md-4">
                                <br />

                                <div class="mb-3">
                                    <label class="form-label" for="validationCustom04">Early Participants</label>
                                    <input type="number" class="form-control" id="nbrTicketEarlyParticipants" placeholder="Early " required="">
                                    <div class="invalid-feedback">
                                        Please provide a valid state.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <br />

                                <div class="mb-3">
                                    <label class="form-label" for="validationCustom05">Ticket Price</label>
                                    <input type="number" class="form-control" id="ticketPriceEvent" placeholder="Ticket Price" required="">
                                    <div class="invalid-feedback">
                                        Please provide a valid zip.
                                    </div>
                                </div>




                            </div>

                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input" id="invalidCheck" required="">
                                            <label class="form-check-label" for="invalidCheck">Agree to terms and conditions</label>
                                            <div class="invalid-feedback">
                                                You must agree before submitting.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button id="btnAddEvent" class="btn btn-primary" type="button">Submit form</button>








</form>
            </div>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>

<script>

    $('#btnAddEvent').click(function () {


        $('#addForm').serialize();

        const format1 = "YYYY-MM-DD";
        const format2 = "YYYY-MM-DD";
       var dateTime1 = moment($('#startDate').val()).format(format1);
       var  dateTime2 = moment($('#endDate').val()).format(format2);


        console.log("*"+dateTime1);
        console.log("*"+dateTime2);
        var nbrTicketEarlyParticipants = parseInt($('#nbrTicketEarlyParticipants').val()); //Output will be 23.
        var totalPlacesEvent = parseFloat($('#totalPlacesEvent').val()); //Output will be 23.
        var ticketPriceEvent = parseFloat($('#ticketPriceEvent').val()); //Output will be 23.
        var discountPercentage = parseFloat($('#discountPercentageEvent').val()); //Output will be 23.
        var image = $('#imageEvent').val();
        $("#imageEvent").attr("src", "data:image/png;base64");
        var conceptName = $('#totalPlacesEvent').find(":selected").text();


        //Control date

        if (dateTime1 > dateTime2) {
            //alert("Please Select To Date Grater Than"+startDate);
            swal("Error!", "Please Select To Date Grater Than " + dateTime1, "error");
            return false;
        }
        else if (moment($('#startDate').val()).format("YYYY-MM-DD") < moment().format("YYYY-MM-DD")) {
            swal("Error!", "Starting date event should be after current date");
            return false;
        }
        else if (conceptName < 0 || ticketPriceEvent < 0 || discountPercentage < 0 || nbrTicketEarlyParticipants < 0) {
            swal("Error!", "Please make sure to pass positive inputs");
            return false;
        }



        var evJson = {
            startDate: dateTime1,
            endDate: dateTime2,
            title: $('#titleEvent').val().trim(),
            description: $('#descriptionEvent').val(),
            address: $('#addressEvent').val(),
            numberOfPlaces: parseInt(conceptName),
            priceTicket: ticketPriceEvent,
            nbrTicketEarlyParticipants: nbrTicketEarlyParticipants,
            discountPercentage: discountPercentage,
            categoryEvent: "MUSIC",

        }

        //file
        var formdata = new FormData();
        var filename = $('input[type=file]').val().replace(/C:\\fakepath\\/i, '')

        var file = $("#imageEvent").val();
        var convert = [];

        for (var i = 0; i < filename.length; i++) {
            convert.push(filename.charCodeAt(i));
        }

        formdata.append("image", filename);
        formdata.append("evJson", JSON.stringify(evJson));





        for (var pair in formdata.entries()) {
            console.log(pair[0]);
            console.log(pair[1]);
        }
        $.ajax({
            type: "POST",
            url: '/Event/CreateEvent',
            data: formdata,
            cache: false,
            contentType: false,
            processData: false,
            success: function (data) {
                console.log(data);
                swal({
                    title: 'Good Job',
                    text: "Event has been saved !",
                    type: 'success'

                }).then(function () {

                    $('#exampleModalScrollable').modal('hide');
                    setInterval('refreshPage()', 2000);


                });


            },

          /*  error: function (err) {
                swal({
                    icon: 'error',
                    title: 'Oops...',
                    text: err.then( error => error),
                    footer: '<a href>Why do I have this issue?</a>'
                })
            }*/
            error:function(request, status, error) {
                alert(request.responseText);
            }
        });



    })
    function refreshPage() {
        location.reload(true);
    }

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

